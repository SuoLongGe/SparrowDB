# å­˜å‚¨ç³»ç»Ÿæ¶æ„è¯´æ˜

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
æ•°æ®åº“å¼•æ“å±‚ (Database Engine)
        â†“ è°ƒç”¨
å­˜å‚¨å¼•æ“å±‚ (StorageEngine) â† ä½ è´Ÿè´£çš„éƒ¨åˆ†
        â†“ å§”æ‰˜ç»™
ç¼“å†²æ± ç®¡ç†å™¨ (BufferPoolManager)
        â†“ å§”æ‰˜ç»™
ç£ç›˜ç®¡ç†å™¨ (DiskManager)
        â†“ æ“ä½œ
ç£ç›˜æ–‡ä»¶ (.dbæ–‡ä»¶)
```

## ğŸ“ æŒä¹…åŒ–æ–‡ä»¶ä½ç½®

æ ¹æ®ä½ çš„æµ‹è¯•ç»“æœï¼ŒæŒä¹…åŒ–æ–‡ä»¶éƒ½åœ¨ `E:\SQLå®è®­\JavaStorageSystem\` ç›®å½•ä¸‹ï¼š

- `test_db.db` (16KB) - åŸºæœ¬æ“ä½œæµ‹è¯•æ•°æ®åº“
- `test_cache.db` (60KB) - ç¼“å­˜æµ‹è¯•æ•°æ®åº“  
- `test_concurrent.db` (36KB) - å¹¶å‘æµ‹è¯•æ•°æ®åº“
- `test_table.db` (12KB) - è¡¨é¡µæ“ä½œæµ‹è¯•æ•°æ®åº“
- `test_persist.db` (12KB) - æŒä¹…åŒ–æµ‹è¯•æ•°æ®åº“
- `test_fifo.db` (60KB) - FIFOç­–ç•¥æµ‹è¯•æ•°æ®åº“
- `debug.db` (4KB) - è°ƒè¯•æµ‹è¯•æ•°æ®åº“
- `index_comparison_test.db` (3.5MB) - ç´¢å¼•å¯¹æ¯”æµ‹è¯•æ•°æ®åº“

## ğŸ”„ è°ƒç”¨æµç¨‹è¯¦è§£

### 1. æ•°æ®åº“å¼•æ“å¦‚ä½•è°ƒç”¨ä½ çš„å­˜å‚¨ç³»ç»Ÿ

```java
// æ•°æ®åº“å¼•æ“åˆ›å»ºå­˜å‚¨å¼•æ“å®ä¾‹
StorageEngine storageEngine = new StorageEngine(10, "database.db", ReplacementPolicy.LRU);

// æ•°æ®åº“å¼•æ“è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ–¹æ³•
Page page = storageEngine.allocateNewPage(pageId);  // åˆ†é…æ–°é¡µé¢
storageEngine.writeRecordToPage(pageId, "data");    // å†™å…¥æ•°æ®
storageEngine.flushAllPages();                      // åˆ·æ–°åˆ°ç£ç›˜
```

### 2. å­˜å‚¨å¼•æ“å†…éƒ¨è°ƒç”¨é“¾

```java
StorageEngine.allocateNewPage()
    â†“ å§”æ‰˜ç»™
BufferPoolManager.newPage()
    â†“ å¦‚æœéœ€è¦ä»ç£ç›˜è¯»å–
DiskManager.readPage()
    â†“ å†™å…¥ç£ç›˜æ–‡ä»¶
database.db æ–‡ä»¶
```

### 3. æ•°æ®æŒä¹…åŒ–è¿‡ç¨‹

#### å†™å…¥æ•°æ®æµç¨‹ï¼š
```
1. æ•°æ®åº“å¼•æ“è°ƒç”¨: storageEngine.writeRecordToPage(pageId, data)
2. å­˜å‚¨å¼•æ“è°ƒç”¨: bufferPoolManager.getPage(pageId)
3. ç¼“å†²æ± ç®¡ç†å™¨æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨å†…å­˜ä¸­
4. å¦‚æœä¸åœ¨ï¼Œä»ç£ç›˜è¯»å–: diskManager.readPage(pageId, pageData)
5. å°†æ•°æ®å†™å…¥é¡µé¢: page.writeString(data)
6. æ ‡è®°é¡µé¢ä¸ºè„é¡µ: releasePage(pageId, true)
7. å®šæœŸæˆ–æ˜¾å¼åˆ·æ–°: bufferPoolManager.flushPage(pageId)
8. ç£ç›˜ç®¡ç†å™¨å†™å…¥: diskManager.writePage(pageId, pageData)
9. æ•°æ®æœ€ç»ˆä¿å­˜åˆ° .db æ–‡ä»¶
```

#### è¯»å–æ•°æ®æµç¨‹ï¼š
```
1. æ•°æ®åº“å¼•æ“è°ƒç”¨: storageEngine.getPage(pageId)
2. å­˜å‚¨å¼•æ“è°ƒç”¨: bufferPoolManager.getPage(pageId)
3. ç¼“å†²æ± ç®¡ç†å™¨æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨å†…å­˜ä¸­
4. å¦‚æœåœ¨å†…å­˜ä¸­ï¼Œç›´æ¥è¿”å› (ç¼“å­˜å‘½ä¸­)
5. å¦‚æœä¸åœ¨å†…å­˜ä¸­ï¼Œä»ç£ç›˜è¯»å–: diskManager.readPage(pageId, pageData)
6. å°†é¡µé¢åŠ è½½åˆ°ç¼“å†²æ± ä¸­
7. è¿”å›é¡µé¢ç»™æ•°æ®åº“å¼•æ“
```

## ğŸ—‚ï¸ æ ¸å¿ƒç»„ä»¶èŒè´£

### StorageEngine (å­˜å‚¨å¼•æ“)
- **èŒè´£**: å¯¹å¤–æä¾›ç»Ÿä¸€æ¥å£ï¼Œéšè—å†…éƒ¨å®ç°ç»†èŠ‚
- **ä¸»è¦æ–¹æ³•**:
  - `allocateNewPage()` - åˆ†é…æ–°é¡µé¢
  - `getPage()` - è·å–é¡µé¢
  - `writeRecordToPage()` - å†™å…¥è®°å½•
  - `flushAllPages()` - åˆ·æ–°æ‰€æœ‰é¡µé¢åˆ°ç£ç›˜
  - `createIntegerIndex()` - åˆ›å»ºç´¢å¼•

### BufferPoolManager (ç¼“å†²æ± ç®¡ç†å™¨)
- **èŒè´£**: ç®¡ç†å†…å­˜ä¸­çš„é¡µé¢ç¼“å­˜ï¼Œå®ç°é¡µé¢æ›¿æ¢ç­–ç•¥
- **ä¸»è¦åŠŸèƒ½**:
  - é¡µé¢ç¼“å­˜ç®¡ç† (LRU/FIFOæ›¿æ¢ç­–ç•¥)
  - é¡µé¢åˆ†é…å’Œé‡Šæ”¾
  - ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
  - çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®

### DiskManager (ç£ç›˜ç®¡ç†å™¨)
- **èŒè´£**: è´Ÿè´£é¡µé¢çš„ç£ç›˜I/Oæ“ä½œ
- **ä¸»è¦åŠŸèƒ½**:
  - ä»ç£ç›˜è¯»å–é¡µé¢
  - å°†é¡µé¢å†™å…¥ç£ç›˜
  - æ•°æ®åº“æ–‡ä»¶çš„åˆ›å»ºå’Œç®¡ç†
  - æ–‡ä»¶é”æœºåˆ¶ä¿è¯å¹¶å‘å®‰å…¨

### Page (é¡µé¢)
- **èŒè´£**: è¡¨ç¤º4KBå¤§å°çš„æ•°æ®é¡µé¢
- **ä¸»è¦åŠŸèƒ½**:
  - å­˜å‚¨å®é™…æ•°æ®
  - æä¾›æ•°æ®è¯»å†™æ¥å£
  - ç®¡ç†é¡µé¢çŠ¶æ€ (è„é¡µã€pinè®¡æ•°ç­‰)

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–æœºåˆ¶

### 1. é¡µé¢å¤§å°
- æ¯ä¸ªé¡µé¢å›ºå®šä¸º **4KB** (4096å­—èŠ‚)
- è¿™æ˜¯æ•°æ®åº“ç³»ç»Ÿçš„æ ‡å‡†é¡µé¢å¤§å°

### 2. æ–‡ä»¶ç»“æ„
```
database.db æ–‡ä»¶ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Page 0    â”‚   Page 1    â”‚   Page 2    â”‚   Page 3    â”‚
â”‚  (4KB)      â”‚  (4KB)      â”‚  (4KB)      â”‚  (4KB)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æŒä¹…åŒ–æ—¶æœº
- **æ˜¾å¼åˆ·æ–°**: è°ƒç”¨ `flushAllPages()` æˆ– `flushPage(pageId)`
- **éšå¼åˆ·æ–°**: é¡µé¢è¢«æ›¿æ¢å‡ºç¼“å†²æ± æ—¶è‡ªåŠ¨åˆ·æ–°
- **ç¨‹åºå…³é—­**: å­˜å‚¨å¼•æ“å…³é—­æ—¶è‡ªåŠ¨åˆ·æ–°æ‰€æœ‰è„é¡µ

### 4. è„é¡µç®¡ç†
- é¡µé¢è¢«ä¿®æ”¹åæ ‡è®°ä¸º"è„é¡µ" (dirty)
- åªæœ‰è„é¡µæ‰ä¼šè¢«å†™å…¥ç£ç›˜
- æœªä¿®æ”¹çš„é¡µé¢ç›´æ¥ä»å†…å­˜è¿”å›ï¼Œæ— éœ€ç£ç›˜I/O

## ğŸ”’ å¹¶å‘æ§åˆ¶

### 1. è¯»å†™é”æœºåˆ¶
- **è¯»é”**: å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»å–é¡µé¢
- **å†™é”**: åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ä¿®æ”¹é¡µé¢
- **å¯é‡å…¥**: åŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–é”

### 2. é¡µé¢é”å®š
- **Pinæœºåˆ¶**: é¡µé¢è¢«ä½¿ç”¨æ—¶å¢åŠ pinè®¡æ•°
- **Unpinæœºåˆ¶**: é¡µé¢ä½¿ç”¨å®Œæ¯•åå‡å°‘pinè®¡æ•°
- **æ›¿æ¢ç­–ç•¥**: åªæœ‰pinè®¡æ•°ä¸º0çš„é¡µé¢æ‰èƒ½è¢«æ›¿æ¢

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜æœºåˆ¶
- å†…å­˜ä¸­ç¼“å­˜å¸¸ç”¨é¡µé¢ï¼Œå‡å°‘ç£ç›˜I/O
- æ”¯æŒLRUå’ŒFIFOä¸¤ç§æ›¿æ¢ç­–ç•¥
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡å’Œç›‘æ§

### 2. æ‰¹é‡æ“ä½œ
- æ”¯æŒæ‰¹é‡åˆ·æ–°é¡µé¢åˆ°ç£ç›˜
- å‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½

### 3. é¢„åˆ†é…
- é¡µé¢é¢„åˆ†é…æœºåˆ¶ï¼Œå‡å°‘è¿è¡Œæ—¶åˆ†é…å¼€é”€

## ğŸ¯ ä¸æ•°æ®åº“å¼•æ“çš„æ¥å£

æ•°æ®åº“å¼•æ“é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ä½ çš„å­˜å‚¨ç³»ç»Ÿï¼š

```java
// 1. åˆå§‹åŒ–å­˜å‚¨å¼•æ“
StorageEngine engine = new StorageEngine(bufferSize, dbFile, policy);

// 2. åˆ›å»ºè¡¨ (åˆ†é…é¡µé¢)
int[] pageId = new int[1];
Page tablePage = engine.allocateTablePage(pageId);

// 3. æ’å…¥æ•°æ®
engine.writeRecordToPage(pageId[0], "record data");

// 4. æŸ¥è¯¢æ•°æ®
Page page = engine.getPage(pageId[0]);
String data = page.readString();

// 5. åˆ›å»ºç´¢å¼•
engine.createIntegerIndex("user_id_index", 10);
engine.insertToIndex("user_id_index", 123, pageId[0]);

// 6. åˆ·æ–°æ•°æ®åˆ°ç£ç›˜
engine.flushAllPages();

// 7. å…³é—­å­˜å‚¨å¼•æ“
engine.close();
```

è¿™å°±æ˜¯ä½ çš„å­˜å‚¨ç³»ç»Ÿå¦‚ä½•è¢«æ•°æ®åº“å¼•æ“è°ƒç”¨ï¼Œä»¥åŠæ•°æ®å¦‚ä½•æŒä¹…åŒ–åˆ°ç£ç›˜æ–‡ä»¶çš„å®Œæ•´æµç¨‹ï¼
